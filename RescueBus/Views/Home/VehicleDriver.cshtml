@model RescueBus.Models.VehicleDriverViewModel
@using RescueBus.Models;
@{
    ViewBag.Title = "VehicleDriver";
}

<div class="row row-cols-1 row-cols-md-1 g-4" style="width: 80%; margin: auto;">
    <div class="col card m-xl-2 my-4 p-xl-4 py-5">
        <div class="d-flex justify-content-between">
            <h2>Drivers</h2>
            <div><a href="/Driver/Create" class="btn btn-primary">Create</a></div>
        </div>
        <div>
            <div class="d-flex gap-5 mb-2">
                <input placeholder="Driver Name" class="form-control" type="text" id="DriverFirstName" />
                <select id="ServiceDropdown" name="ServiceID" class="form-select" asp-for="ServiceID">
                    <option value="">Service</option>
                    @foreach (var service in ViewBag.Services)
                    {
                        <option value="@service.ServiceID">@service.Name</option>
                    }

                </select>

                <button id="btn-Search" class="btn btn-success">Search</button>
            </div>
            <table class="table" id="drivers">
                <thead class="table-secondary">
                    <tr>
                        <th>
                            IMAGE
                        </th>
                        <th>
                            FIRST NAME
                        </th>
                        <th>
                            LAST NAME
                        </th>
                        <th>
                            PHONE NUMBER
                        </th>
                        <th>
                            SERVICE
                        </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Drivers)
                    {
                        var serviceName = ServiceRepository.Services.FirstOrDefault(s => s.ServiceID == item.ServiceID)?.Name ?? "";
                        <tr data-firstname="@item.FirstName.ToLower()" data-service="@serviceName.ToLower()">
                            <td><img src="@item.ImagePath" alt="Driver" width="50" /></td>
                            <td>@Html.DisplayFor(modelItem => item.FirstName)</td>
                            <td>@Html.DisplayFor(modelItem => item.LastName)</td>
                            <td>@Html.DisplayFor(modelItem => item.PhoneNumber)</td>
                            <td>@serviceName</td>
                            <td>
                                @Html.ActionLink("Edit", "Edit", "Driver", new { id = item.DriverID }, new { @class = "btn btn-warning" })
                                @Html.ActionLink("Delete", "Delete", "Driver", new { id = item.DriverID }, new { @class = "btn btn-danger" })
                            </td>
                        </tr>
                    }

                </tbody>
            </table>
        </div>

    </div>
    <div class="col card m-xl-2 my-4 p-xl-4 py-5">
        <div class="d-flex justify-content-between">
            <h2>Vehicles</h2>
            <div><a href="/Vehicle/Create" class="btn btn-primary">Create</a></div>
        </div>
        <table class="table">

            <thead class="table-secondary">
                <tr>
                    <th>
                        IMAGE
                    </th>
                    <th>
                        TYPE
                    </th>
                    <th>
                        REGISTRATION
                    </th>
                    <th>
                        SERVICE
                    </th>
                    <th>
                        Controls
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Vehicles)
                {
                    <tr>


                        <td>
                            <img src="@item.ImagePath" alt="Vehicle" width="100" />

                        </td>

                        <td>
                            @Html.DisplayFor(modelItem => item.Type)
                        </td>

                        <td>
                            @Html.DisplayFor(modelItem => item.RegistrationNumber)
                        </td>
                        <td>

                            @(ServiceRepository.Services.FirstOrDefault(s => s.ServiceID == item.ServiceID)?.Name)
                        </td>
                        <td>
                            @Html.ActionLink("Edit", "Edit", "Vehicle", new { id = item.VehicleID }, new { @class = "btn btn-warning" })

                            @Html.ActionLink("Delete", "Delete", "Vehicle", new { id = item.VehicleID }, new { @class = "btn btn-danger" })
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="d-flex justify-content-end">
            <form method="post" action="@Url.Action("ExportToTextFile", "Vehicle")">
                <button type="submit" class="btn btn-success">Export Vehicles to Text File</button>
            </form>
        </div>
    </div>
</div>

@section Scripts{

    <script>
    document.getElementById("btn-Search").addEventListener("click", function () {
        const nameInput = document.getElementById("DriverFirstName").value.trim().toLowerCase();
        const serviceInput = document.getElementById("ServiceDropdown").value;

        const rows = document.querySelectorAll("#drivers tbody tr");

        rows.forEach(row => {
            const rowName = row.getAttribute("data-firstname");
            const rowServiceId = row.getAttribute("data-service");

            const nameMatches = !nameInput || rowName.includes(nameInput);
            const serviceMatches = !serviceInput || rowServiceId === document.querySelector(`#ServiceDropdown option[value="${serviceInput}"]`)?.textContent.toLowerCase();

            if (nameMatches && serviceMatches) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    });
    </script>


}
